generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  passwordHash    String   @map("password_hash")
  firstName       String?  @map("first_name")
  lastName        String?  @map("last_name")
  phone           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  events          Event[]
  scores          Score[]
  userMissions    UserMission[]
  walletTransactions WalletTransaction[]
  riskProfile     RiskProfile?
  features        Feature[]

  @@map("users")
}

model Event {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  eventType   String   @map("event_type")
  eventData   Json     @map("event_data")
  timestamp   DateTime @default(now())
  metadata    Json?

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@index([eventType])
  @@map("events")
}

model Feature {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")
  calculatedAt        DateTime @default(now()) @map("calculated_at")

  activityDays        Int      @default(0) @map("activity_days")
  streakCurrent       Int      @default(0) @map("streak_current")
  streakLongest       Int      @default(0) @map("streak_longest")
  eventDiversity      Float    @default(0) @map("event_diversity")
  totalEvents         Int      @default(0) @map("total_events")
  avgEventsPerDay     Float    @default(0) @map("avg_events_per_day")
  lastActivityDate    DateTime? @map("last_activity_date")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("features")
}

model Score {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  totalScore            Int      @map("total_score")
  consistencyScore      Int      @map("consistency_score")
  capacityScore         Int      @map("capacity_score")
  integrityScore        Int      @map("integrity_score")
  engagementQualityScore Int     @map("engagement_quality_score")

  drivers               Json
  nextActions           Json     @map("next_actions")

  calculatedAt          DateTime @default(now()) @map("calculated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, calculatedAt])
  @@map("scores")
}

model Mission {
  id              String   @id @default(uuid())
  name            String
  description     String
  type            String
  frequency       String
  requirements    Json
  scoreBonus      Int      @map("score_bonus")
  rewardPoints    Int      @map("reward_points")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  userMissions    UserMission[]

  @@map("missions")
}

model UserMission {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  missionId       String   @map("mission_id")
  status          String   @default("active")
  progress        Json     @default("{}")
  assignedAt      DateTime @default(now()) @map("assigned_at")
  completedAt     DateTime? @map("completed_at")
  expiresAt       DateTime? @map("expires_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission         Mission  @relation(fields: [missionId], references: [id])

  @@index([userId, status])
  @@map("user_missions")
}

model Reward {
  id              String   @id @default(uuid())
  name            String
  description     String
  category        String
  pointsCost      Int      @map("points_cost")
  isAvailable     Boolean  @default(true) @map("is_available")
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  walletTransactions WalletTransaction[]

  @@map("rewards")
}

model WalletTransaction {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  type            String
  amount          Int
  description     String
  rewardId        String?  @map("reward_id")
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reward          Reward?  @relation(fields: [rewardId], references: [id])

  @@index([userId, createdAt])
  @@map("wallet_transactions")
}

model RiskProfile {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  riskState       String   @default("ok") @map("risk_state")
  flags           Json     @default("[]")
  velocityScore   Float    @default(0) @map("velocity_score")
  deviceFingerprint String? @map("device_fingerprint")
  lastFlaggedAt   DateTime? @map("last_flagged_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("risk_profile")
}
